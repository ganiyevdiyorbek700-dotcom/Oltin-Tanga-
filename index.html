<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Oltin Tanga - Pro Max Clicker</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
    
    <!-- Monetag reklama SDK (sizning zone ID'ingiz) -->
    <script src="//libtl.com/sdk.js" data-zone="10558007" data-sdk="show_10558007"></script>
    
    <!-- TON Connect SDK (hamyon ulash uchun) -->
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>

    <style>
        :root { --gold: #ffd700; --bg: #0b0d17; --card: #1c222d; --green: #2ecc71; --red: #e74c3c; --blue: #0088cc; --orange: #ffa500; --purple: #8b5cf6; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { margin: 0; background: var(--bg); color: white; font-family: 'Segoe UI', sans-serif; overflow: hidden; }

        /* Loading animatsiyasi (5 soniya, xato handling bilan) */
        #loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 5000; transition: opacity 0.5s; }
        .loading-spinner { width: 50px; height: 50px; border: 5px solid rgba(255,215,0,0.3); border-top: 5px solid var(--gold); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loading-text { margin-top: 20px; font-size: 18px; color: var(--gold); }

        .bg-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; opacity: 0.4; pointer-events: none; background: radial-gradient(circle at center, var(--gold), transparent 70%); transition: all 0.5s; }
        .card-effect { animation: card-appear 0.5s ease-out; }
        @keyframes card-appear { 0% { transform: scale(0); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .tap-effect { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 30px; color: var(--green); pointer-events: none; animation: tap-float 0.5s ease-out forwards; z-index: 10; }
        @keyframes tap-float { 0% { opacity: 1; transform: translate(-50%, -50%) scale(1); } 100% { opacity: 0; transform: translate(-50%, -50%) scale(1.5) translateY(-20px); } }

        .top-stats { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; padding: 12px; background: rgba(0,0,0,0.6); }
        .stat-box { background: var(--card); padding: 6px; border-radius: 8px; text-align: center; border: 1px solid #333; }
        .stat-box small { font-size: 10px; color: #aaa; display: block; }
        .stat-box b { font-size: 13px; color: var(--gold); }

        .game-area { display: flex; flex-direction: column; align-items: center; justify-content: flex-end; height: 50vh; padding-bottom: 30px; position: relative; }
        #balance-main { color: var(--gold); font-size: 38px; margin-bottom: 10px; font-weight: bold; text-shadow: 0 0 10px rgba(255,215,0,0.3); }
        .coin-wrapper { width: 230px; height: 230px; cursor: pointer; transition: transform 0.05s; position: relative; }
        .coin-main { width: 100%; height: 100%; background: radial-gradient(circle, var(--gold), #ffb300); border-radius: 50%; border: 10px solid #cc8e00; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 40px; color: #4d3300; box-shadow: 0 0 30px rgba(255,215,0,0.2); }
        #tap-power-val { font-size: 14px; margin-top: 5px; color: var(--green); }
        .coin-wrapper:active { transform: scale(0.92); }

        .energy-container { width: 80%; text-align: center; margin-top: 15px; }
        .energy-bar-bg { width: 100%; height: 10px; background: #222; border-radius: 5px; overflow: hidden; margin-top: 5px; }
        #energy-fill { height: 100%; background: var(--gold); width: 100%; transition: width 0.2s; }

        /* Bonus chap tomonda */
        .bonus-section { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); width: 120px; }
        .bonus-card { background: var(--card); padding: 10px; border-radius: 10px; margin-bottom: 10px; text-align: center; border: 1px solid #333; }
        .bonus-timer { font-size: 10px; color: #aaa; }

        /* Omadli quti o'ng tomonda */
        .lucky-section { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); width: 120px; }
        .lucky-card { background: var(--card); padding: 10px; border-radius: 10px; text-align: center; border: 1px solid #333; }
        .lucky-timer { font-size: 10px; color: #aaa; }

        .nav-bar { position: fixed; bottom: 0; width: 100%; background: #07090c; display: flex; justify-content: space-around; padding: 15px 5px; border-top: 1px solid #222; z-index: 100; }
        .nav-btn { color: #666; text-align: center; font-size: 11px; flex: 1; cursor: pointer; }
        .nav-btn.active { color: var(--gold); }

        .page { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 200; padding: 20px; display: none; overflow-y: auto; padding-bottom: 110px; }
        .card { background: var(--card); padding: 15px; border-radius: 15px; margin-bottom: 15px; border: 1px solid #333; position: relative; transition: all 0.3s; }
        .card:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(255,215,0,0.2); }
        .btn { width: 100%; padding: 14px; border: none; border-radius: 10px; font-weight: bold; background: var(--gold); color: #000; cursor: pointer; margin-top: 8px; font-size: 15px; transition: all 0.2s; }
        .btn:hover { background: #ffb300; transform: scale(1.02); }
        .btn:disabled { background: #666; cursor: not-allowed; }
        .lock-overlay { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.85); border-radius:15px; display:flex; align-items:center; justify-content:center; color: #ff4d4d; font-weight:bold; z-index: 5; text-align: center;}

        /* Bildirishnomalar (rangli, professional) */
        .notification { position: fixed; top: 20px; right: 20px; padding: 12px 20px; border-radius: 10px; z-index: 4000; display: none; font-weight: bold; text-align: center; min-width: 200px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); animation: slide-in 0.3s ease; }
        @keyframes slide-in { from { transform: translateX(100%); } to { transform: translateX(0); } }
        .notify-green { background: var(--green); color: white; }
        .notify-red { background: var(--red); color: white; }

        #notify-main { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); padding: 12px 20px; border-radius: 30px; z-index: 3000; display: none; font-weight: bold; text-align: center; color: white; }
    </style>
</head>
<body>

<!-- Loading screen (5s, xato handling bilan) -->
<div id="loading-screen">
    <div class="loading-spinner"></div>
    <div class="loading-text">O'yin yuklanmoqda... (5 soniya)</div>
</div>

<div id="notify-main"></div>
<div class="notification notify-green" id="notify-green"></div>
<div class="notification notify-red" id="notify-red"></div>

<div id="bg-fx" class="bg-overlay"></div>

<div class="top-stats">
    <div class="stat-box"><small>üìÄ Tanga/soat</small><b id="coin-pph-val">0</b></div>
    <div class="stat-box"><small>üíé Olmos/soat</small><b id="diam-pph-val">0</b></div>
    <div class="stat-box"><small>‚≠ê Daraja</small><b id="lvl-val">1</b></div>
</div>

<div class="game-area">
    <div id="balance-main">0</div>
    <div class="coin-wrapper" onclick="handleTap(event)">
        <div class="coin-main">
            <div id="tap-power-val">+1</div>
        </div>
    </div>
    <div class="energy-container">
        <span>‚ö° <span id="e-text">500/500</span></span>
        <div class="energy-bar-bg"><div id="energy-fill"></div></div>
    </div>
</div>

<!-- 7-kunlik bonus chap tomonda -->
<div class="bonus-section">
    <div class="bonus-card">
        <h4>7-kunlik Bonus</h4>
        <div id="bonus-list"></div>
    </div>
</div>

<!-- Omadli quti o'ng tomonda -->
<div class="lucky-section">
    <div class="lucky-card">
        <h4>Omadli Quti</h4>
        <p id="lucky-timer">Kuniga 1 marta</p>
        <button class="btn" onclick="openLuckyBox()" id="lucky-btn" style="font-size:12px; padding:8px;">O'ynash</button>
        <div id="lucky-boxes" style="display:none;">
            <button class="btn" onclick="chooseBox(1)">Quti 1</button>
            <button class="btn" onclick="chooseBox(2)">Quti 2</button>
            <button class="btn" onclick="chooseBox(3)">Quti 3</button>
        </div>
    </div>
</div>

<div class="nav-bar">
    <div class="nav-btn" onclick="openPage('p-market')">Bozor</div>
    <div class="nav-btn" onclick="openPage('p-referral')">Referral</div>
    <div class="nav-btn" onclick="openPage('p-rank')">Reyting</div>
    <div class="nav-btn" onclick="openPage('p-boost')">Booster</div>
    <div class="nav-btn" onclick="openPage('p-home')">Profil</div>
</div>

<!-- Bozor sahifasi (10 ta karta + minerlar) -->
<div id="p-market" class="page">
    <span style="float:right; font-size:30px;" onclick="closePage('p-market')">‚úñ</span>
    <h2>Bozor üõí</h2>
    <h3>Kartalar (10 ta)</h3>
    <div id="cards-list"></div>
    <h3>Minerlar (5 tanga + 5 olmos)</h3>
    <div id="miners-list"></div>
</div>

<!-- Referral sahifasi -->
<div id="p-referral" class="page">
    <span style="float:right; font-size:30px;" onclick="closePage('p-referral')">‚úñ</span>
    <h2>Referral üë•</h2>
    <div class="card">
        <p>Do'stlaringizni chaqiring va har biri uchun 50,000 tanga oling!</p>
        <button class="btn" onclick="copyReferral()">Havola nusxalash va ulashish</button>
        <p>Havola: t.me/OltinTanga1_bot?start=ref_<span id="ref-id"></span></p>
    </div>
</div>

<!-- Reyting sahifasi -->
<div id="p-rank" class="page">
    <span style="float:right; font-size:30px;" onclick="closePage('p-rank')">‚úñ</span>
    <h2>Reyting üèÜ</h2>
    <div id="rank-list"></div>
</div>

<!-- Booster sahifasi -->
<div id="p-boost" class="page">
    <span style="float:right; font-size:30px;" onclick="closePage('p-boost')">‚úñ</span>
    <h2>Booster ‚ö°</h2>
    <div class="card"><b>Tap Kuchini +1</b><button class="btn" onclick="buyBoost('tap')">Narxi: <span id="c-tap">100</span> tanga</button></div>
    <div class="card"><b>Energiya Sig'imi +100</b><button class="btn" onclick="buyBoost('energy')">Narxi: <span id="c-energy">200</span> tanga</button></div>
    <div class="card"><b>Super Tap (<span id="super-count">3</span>/3)</b><button class="btn" onclick="activateSuperTap()">Ishga tushir (Reklama ko'rish)</button></div>
</div>

<!-- Profil sahifasi -->
<div id="p-home" class="page">
    <span style="float:right; font-size:30px;" onclick="closePage('p-home')">‚úñ</span>
    <h2>Profil üë§</h2>
    <div class="card">Ism: <b id="u-name">...</b><br>ID: <b id="u-id">...</b><br>Tangalar: <b id="p-coins">0</b><br>Olmoslar: <b id="p-diams">0</b><br>Daraja: <b id="p-lvl">1</b></div>
    <button class="btn" onclick="tonConnectUI.openModal()" style="background:var(--blue); color:white;">TON Hamyon ulash</button>
    <div id="ton-connect-button-root"></div>
    <button class="btn" style="background:var(--orange); color:white;" onclick="withdrawTON()">TON Chiqarish (Minimal 5 TON)</button>
    <div class="card">
        <h3>O'yin haqida</h3>
        <p>Tanga bosib to'plang, minerlar offline mining qiladi. Kartalar effekt beradi (suvli, olovli va h.k.). Referral orqali bonus oling. TON wallet ulab, yig'ilgan tangalarni TON ga konvert qilib chiqaring (Binance orqali sotish mumkin). Booster va bonuslar bilan daromadni oshiring!</p>
    </div>
</div>

<script>
// Firebase sozlamalari (sizning loyihangiz, yangi versiya bilan)
const firebaseConfig = { databaseURL: "https://oltin-tanga-d2c80-default-rtdb.firebaseio.com" };
let firebaseApp;
try {
    firebaseApp = firebase.initializeApp(firebaseConfig);
} catch (error) {
    console.error('Firebase init xatosi:', error);
    document.getElementById('loading-screen').innerHTML += '<div style="color:red; margin-top:20px;">Firebase ulanishda xato. Internetni tekshiring.</div>';
}
const db = firebase.database();
const tg = window.Telegram.WebApp;
const user = tg.initDataUnsafe?.user || { id: "12345", first_name: "Mehmon" };

let s = { coins: 0, diamonds: 0, lvl: 1, pphCoin: 0, pphDiam: 0, energy: 500, maxE: 500, tap: 1, tapLvl: 1, pphLvl: 1, eLvl: 1, lastD: 0, luckyC: 3, skin: 'default', taskDone: false, lastTime: Date.now(), walletAddress: null, superTapCount: 3, superTapActive: false, superTapEnd: 0, miners: Array(10).fill(0), cards: Array(10).fill(false), referrals: 0, bonusDays: 0, luckyTime: 0 };

// Kartalar va minerlar ma'lumotlari (professional, to'liq)
const cardsData = [
    { name: 'Suvli Karta', effect: 'Suv effekti (energiya +10%)', price: 100, property: 'water' },
    { name: 'Olovli Karta', effect: 'Olov alangasi (tap +5)', price: 150, property: 'fire' },
    { name: 'Olmosli Karta', effect: 'Olmos yorqinligi (olmos +5%)', price: 200, property: 'diamond' },
    { name: 'Yer Karti', effect: 'Yer titrashi (mining +10%)', price: 250, property: 'earth' },
    { name: 'Havo Karti', effect: 'Shamol effekti (tezlik +15%)', price: 300, property: 'air' },
    { name: 'Energiya Karti', effect: 'Energiya to\'lqin (maxE +20%)', price: 350, property: 'energy' },
    { name: 'Tezlik Karti', effect: 'Tezlik chizig\'i (tap tezligi)', price: 400, property: 'speed' },
    { name: 'Kuchli Karta', effect: 'Kuch portlashi (power +20)', price: 450, property: 'strength' },
    { name: 'Sirli Karta', effect: 'Sirli bulut (random bonus)', price: 500, property: 'mystery' },
    { name: 'Oltin Karta', effect: 'Oltin yomg\'ir (coins x2 1 soat)', price: 600, property: 'gold' }
];

const minersData = [
    { name: 'Tanga Miner 1', type: 'coin', baseMining: 10, price: 100 },
    { name: 'Tanga Miner 2', type: 'coin', baseMining: 20, price: 200 },
    { name: 'Tanga Miner 3', type: 'coin', baseMining: 30, price: 300 },
    { name: 'Tanga Miner 4', type: 'coin', baseMining: 40, price: 400 },
    { name: 'Tanga Miner 5', type: 'coin', baseMining: 50, price: 500 },
    { name: 'Olmos Miner 1', type: 'diam', baseMining: 5, price: 150 },
    { name: 'Olmos Miner 2', type: 'diam', baseMining: 10, price: 300 },
    { name: 'Olmos Miner 3', type: 'diam', baseMining: 15, price: 450 },
    { name: 'Olmos Miner 4', type: 'diam', baseMining: 20, price: 600 },
    { name: 'Olmos Miner 5', type: 'diam', baseMining: 25, price: 750 }
];

// TON Connect (professional handling)
const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
    manifestUrl: 'https://sizning-vercel-url.vercel.app/tonconnect-manifest.json', // O'zingizning URL
    buttonRootId: 'ton-connect-button-root',
    uiPreferences: { theme: 'DARK' },
    actionsConfiguration: { twaReturnUrl: 'https://t.me/OltinTanga1_bot/app' }
});
tonConnectUI.onStatusChange(walletInfo => {
    if (walletInfo?.connected) {
        s.walletAddress = walletInfo.account?.address;
        showNotify('TON Hamyon muvaffaqiyatli ulandi! ‚úÖ', 'green');
        save();
    } else {
        s.walletAddress = null;
        showNotify('Hamyon uzildi. Qayta ulang.', 'red');
        save();
    }
});

// Reklama funksiyasi (professional, callback bilan)
function runAd(callback, context = '') {
    showNotify(`Reklama ko'rilmoqda... (${context})`, 'orange');
    if (typeof show_10558007 === 'function') {
        show_10558007().then(() => { 
            showNotify('Reklama tugadi! Bonus faol.', 'green');
            if(callback) callback(); 
        }).catch(() => {
            showNotify('Reklama xatosi. Qayta urinib ko\'ring.', 'red');
            if(callback) callback();
        });
    } else { 
        // Fallback: callback chaqirish
        if(callback) callback(); 
        showNotify('Reklama fallback: Bonus berildi.', 'green');
    }
}

// Ma'lumotlarni yuklash (offline mining bilan, professional error handling)
db.ref('users/' + user.id).on('value', snap => {
    try {
        if(snap.exists()) {
            let data = snap.val();
            let now = Date.now();
            // Offline mining (minerlar hisobi)
            if(data.lastTime) {
                let diff = Math.floor((now - data.lastTime)/1000);
                let minedCoins = 0, minedDiams = 0;
                (data.miners || Array(10).fill(0)).forEach((m, i) => {
                    if (minersData[i]) {
                        let mining = m * minersData[i].baseMining;
                        if (minersData[i].type === 'coin') minedCoins += mining * diff / 3600;
                        else minedDiams += mining * diff / 3600;
                    }
                });
                s.coins = (data.coins || 0) + Math.floor(minedCoins);
                s.diamonds = (data.diamonds || 0) + Math.floor(minedDiams);
                s.energy = Math.min(data.maxE || 500, (data.energy || 0) + diff * 0.1);
            } else { Object.assign(s, data); }
        }
        updateUI();
        loadMiners();
        loadCards();
        loadBonus();
        loadLucky();
        loadRank();
        // Kirish bildirishnomasi (professional)
        let offlineMined = Math.floor(minedCoins + minedDiams);
        if (offlineMined > 0) showNotify(`Offline mining: +${offlineMined} resurs yig'ildi! üí∞`, 'green');
    } catch (error) {
        console.error('Ma\'lumot yuklash xatosi:', error);
        showNotify('Ma\'lumot yuklashda xato. Qayta urinib ko\'ring.', 'red');
    }
});

// UI yangilash (to'liq professional)
function updateUI() {
    const levels = [0, 10000, 50000, 100000, 500000, 1000000];
    let clvl = 1; levels.forEach((v, i) => { if(s.coins >= v) clvl = i+1; });
    s.lvl = clvl;

    document.getElementById('balance-main').innerText = Math.floor(s.coins).toLocaleString();
    document.getElementById('coin-pph-val').innerText = s.pphCoin;
    document.getElementById('diam-pph-val').innerText = s.pphDiam;
    document.getElementById('diam-total-val').innerText = Math.floor(s.diamonds).toLocaleString();
    document.getElementById('lvl-val').innerText = s.lvl;
    document.getElementById('tap-power-val').innerText = "+" + (s.superTapActive ? 1000 : s.tap);
    document.getElementById('e-text').innerText = Math.floor(s.energy) + "/" + s.maxE;
    document.getElementById('energy-fill').style.width = (s.energy/s.maxE*100) + "%";
    
    document.getElementById('u-name').innerText = user.first_name;
    document.getElementById('u-id').innerText = user.id;
    document.getElementById('p-coins').innerText = Math.floor(s.coins).toLocaleString();
    document.getElementById('p-diams').innerText = Math.floor(s.diamonds).toLocaleString();
    document.getElementById('p-lvl').innerText = s.lvl;
    document.getElementById('ref-id').innerText = user.id;
    document.getElementById('super-count').innerText = s.superTapCount;
}

// Tap funksiyasi (effektlar bilan, professional)
function handleTap(e) {
    let power = s.superTapActive ? 1000 : s.tap;
    let cost = power; // Energiya sarfi
    if(s.energy >= cost) {
        s.coins += power;
        s.energy -= cost;
        // Tap effekti (professional animatsiya)
        let effect = document.createElement('div');
        effect.className = 'tap-effect';
        effect.innerText = `+${power}`;
        e.target.appendChild(effect);
        setTimeout(() => effect.remove(), 500);
        // Karta effekti (agar sotib olingan bo'lsa)
        let activeCard = s.cards.findIndex(c => c);
        if (activeCard !== -1) {
            let prop = cardsData[activeCard].property;
            document.getElementById('bg-fx').style.background = prop === 'fire' ? 'radial-gradient(circle, red, orange)' : prop === 'water' ? 'radial-gradient(circle, blue, cyan)' : prop === 'gold' ? 'radial-gradient(circle, var(--gold), yellow)' : 'radial-gradient(circle, var(--gold), transparent)';
            setTimeout(() => document.getElementById('bg-fx').style.background = 'radial-gradient(circle, var(--gold), transparent)', 2000);
        }
        updateUI();
        save();
        showNotify(`+${power} tanga topildi! üí∞`, 'green');
    } else {
        showNotify("Energiya tugadi! Reklama ko'ring va to'ldiring.", "red");
        runAd(() => { s.energy = s.maxE; updateUI(); showNotify("Energiya to'liq tiklandi! ‚ö°", "green"); }, 'energiya to\'ldirish');
    }
}

// Super Tap (3/marta, 30s, reklama bilan)
let superTapInterval;
function activateSuperTap() {
    if (s.superTapCount > 0 && !s.superTapActive) {
        runAd(() => {
            s.superTapActive = true;
            s.superTapCount--;
            s.superTapEnd = Date.now() + 30000; // 30 soniya
            superTapInterval = setInterval(() => {
                if (Date.now() > s.superTapEnd) {
                    s.superTapActive = false;
                    clearInterval(superTapInterval);
                    updateUI();
                    showNotify('Super Tap tugadi. Keyingi reklama bilan qayta ishga tushiring.', 'orange');
                }
            }, 1000);
            updateUI();
            save();
            showNotify('Super Tap faol! 30 soniya ichida har tap +1000! ‚ö°', 'green');
        }, 'super tap');
    } else {
        showNotify("Kuniga 3 marta imkoniyat! Yoki hozir faol.", "red");
    }
}

// Bozor yuklash (kartalar, professional)
function loadCards() {
    let html = '';
    cardsData.forEach((card, i) => {
        let bought = s.cards[i];
        html += `<div class="card \( {bought ? 'card-effect' : ''}"><b> \){card.name}</b><p>\( {card.effect} ( \){card.property})</p><button class="btn" \( {bought ? 'disabled style="background:#666;"' : ''} onclick=" \){bought ? '' : `buyCard(\( {i})`}"> \){bought ? 'Sotib olingan ‚úÖ' : `Sotib olish (${card.price} üíé)`}</button></div>`;
    });
    document.getElementById('cards-list').innerHTML = html;
}

// Karta sotib olish (effektlar bilan)
function buyCard(i) {
    let card = cardsData[i];
    if (s.diamonds >= card.price) {
        s.diamonds -= card.price;
        s.cards[i] = true;
        // Effekt: fon o'zgarishi (professional)
        let originalBg = document.getElementById('bg-fx').style.background;
        document.getElementById('bg-fx').style.background = card.property === 'fire' ? 'radial-gradient(circle, #ff4500, red)' : card.property === 'water' ? 'radial-gradient(circle, #00bfff, blue)' : card.property === 'earth' ? 'radial-gradient(circle, #8b4513, brown)' : card.property === 'air' ? 'radial-gradient(circle, #87ceeb, white)' : card.property === 'gold' ? 'radial-gradient(circle, var(--gold), yellow)' : 'radial-gradient(circle, var(--purple), indigo)';
        loadCards();
        updateUI();
        save();
        showNotify(`${card.name} sotib olindi! Effekt faol bo'ldi üåü`, "green");
        setTimeout(() => document.getElementById('bg-fx').style.background = originalBg, 3000);
    } else {
        showNotify("Olmos yetarli emas! Bozorga ko'proq olmos yig'ing.", "red");
    }
}

// Minerlar yuklash (professional, 5+5)
function loadMiners() {
    let html = '';
    minersData.forEach((miner, i) => {
        let level = s.miners[i] || 1;
        let mining = level * miner.baseMining;
        let nextPrice = miner.price * level;
        html += `<div class="card"><b>\( {miner.name} (Lv \){level})</b><p>\( {miner.type === 'coin' ? 'Tanga' : 'Olmos'} mining: + \){mining}/soat (offline ham)</p><button class="btn" onclick="upgradeMiner(\( {i})">Kuchaytirish ( \){nextPrice} tanga)</button></div>`;
    });
    document.getElementById('miners-list').innerHTML = html;
}

// Miner kuchaytirish
function upgradeMiner(i) {
    let miner = minersData[i];
    let level = s.miners[i] || 1;
    let nextPrice = miner.price * level;
    if (s.coins >= nextPrice) {
        s.coins -= nextPrice;
        s.miners[i] = level + 1;
        loadMiners();
        updateUI();
        save();
        showNotify(`\( {miner.name} kuchaytirildi! Endi + \){s.miners[i] * miner.baseMining} mining/soat üíé`, "green");
    } else {
        showNotify("Tanga yetarli emas! Miner sotib oling yoki mining qiling.", "red");
    }
}

// Referral (professional, ulashish)
function copyReferral() {
    let link = `https://t.me/OltinTanga1_bot?start=ref_${user.id}`;
    tg.openTelegramLink(`https://t.me/share/url?url=${encodeURIComponent(link)}&text=Oltin Tanga o\'ynaylik! Menga referral bonus bering va 50k tanga oling! üí∞`);
    // Simulyatsiya (realda backendda hisoblang)
    s.coins += 50000;
    s.referrals++;
    updateUI();
    save();
    showNotify('Referral havola ulashildi! Har do\'st uchun +50,000 tanga bonus! üë•', "green");
}

// Reyting (medallar bilan, professional)
function loadRank() {
    db.ref('users').orderByChild('coins').limitToLast(10).once('value', snap => {
        try {
            let list = []; snap.forEach(c => {
                let d = c.val();
                list.push({name: d.first_name || "Anonim", id: c.key, coins: d.coins || 0, diamonds: d.diamonds || 0, lvl: d.lvl || 1});
            });
            list.sort((a,b) => b.coins - a.coins);
            let html = '';
            list.forEach((u, i) => {
                let medal = i === 0 ? 'ü•á Oltin Medali' : i === 1 ? 'ü•à Kumush Medali' : i === 2 ? 'ü•â Bronza Medali' : `#${i+1}`;
                let color = i < 3 ? (i === 0 ? 'gold' : i === 1 ? 'silver' : '#cd7f32') : 'white';
                html += `<div class="card" style="border-left: 4px solid \( {color};"><b style="color: \){color};">${medal} - ${u.name}</b><br><small>ID: ${u.id} | Daraja: ${u.lvl} | Tanga: ${Math.floor(u.coins).toLocaleString()} | Olmos: ${u.diamonds}</small></div>`;
            });
            document.getElementById('rank-list').innerHTML = html;
        } catch (error) {
            document.getElementById('rank-list').innerHTML = '<div class="card">Reyting yuklashda xato. Qayta urinib ko\'ring.</div>';
        }
    });
}

// Booster (professional)
function buyBoost(type) {
    let cost = type === 'tap' ? 100 * s.tapLvl : 200 * s.eLvl;
    if (s.coins >= cost) {
        s.coins -= cost;
        if (type === 'tap') { s.tapLvl++; s.tap++; }
        if (type === 'energy') { s.eLvl++; s.maxE += 100; s.energy = Math.min(s.energy, s.maxE); }
        updateUI();
        save();
        showNotify(`${type === 'tap' ? 'Tap kuchi' : 'Energiya sig\'imi'} kuchaytirildi! +1 daraja ‚ö°`, "green");
    } else {
        showNotify("Tanga yetarli emas! Mining qiling yoki referral orqali bonus oling.", "red");
    }
}

// TON chiqarish (professional, minimal chek)
function withdrawTON() {
    if (!s.walletAddress) {
        showNotify("Avval TON hamyonni ulang! Profil sahifasida.", "red");
        tonConnectUI.openModal();
        return;
    }
    if (s.coins < 5000) {
        showNotify("Minimal 5000 tanga yig'ing! (Hozir: " + Math.floor(s.coins) + ")", "red");
        return;
    }
    runAd(() => {
        showNotify("TON muvaffaqiyatli chiqarildi! Wallet: " + s.walletAddress.slice(0,6) + "... (Binance orqali sotish mumkin)", "green");
        // Real transaction (nanoTON da)
        // tonConnectUI.sendTransaction({ to: s.walletAddress, value: (s.coins * 0.001).toString() + '000000000' });
        s.coins = 0; // Chiqarilgandan keyin nolga tushirish
        updateUI();
        save();
    }, 'chiqarish tasdiqlash');
}

// 7-kunlik bonus (timer bilan, reklama)
function loadBonus() {
    let html = '';
    for (let day = 1; day <= 7; day++) {
        let claimed = s.bonusDays >= day;
        let nextTime = s.lastD + 86400000 * day;
        let remaining = claimed ? 0 : Math.max(0, (nextTime - Date.now()) / 1000);
        let timer = claimed ? 'Olingan ‚úÖ' : remaining > 0 ? `Qolgan: ${Math.floor(remaining / 3600)}soat ${Math.floor((remaining % 3600) / 60)}daqiqa` : 'Olish mumkin!';
        html += `<div class="bonus-card"><b>Kun \( {day}</b><p>+ \){day * 1000} tanga</p><button class="btn" \( {claimed || remaining > 0 ? 'disabled' : ''} onclick=" \){claimed || remaining > 0 ? '' : `claimBonus(\( {day})`}"> \){timer}</button></div>`;
    }
    document.getElementById('bonus-list').innerHTML = html;
}
function claimBonus(day) {
    if (s.bonusDays < day) {
        runAd(() => {
            s.coins += day * 1000;
            s.bonusDays = day;
            s.lastD = Date.now();
            loadBonus();
            updateUI();
            save();
            showNotify(`Kun \( {day} bonus: + \){day * 1000} tanga! üéÅ`, "green");
        }, 'kunlik bonus');
    }
}

// Omadli quti (3 quti, 1/kun, timer)
let luckyOpen = false;
function openLuckyBox() {
    let now = Date.now();
    if (now - s.luckyTime < 86400000) {
        let remaining = Math.max(0, (s.luckyTime + 86400000 - now) / 1000);
        showNotify(`Kuniga 1 marta! Qolgan: ${Math.floor(remaining / 3600)}soat`, "red");
        return;
    }
    runAd(() => {
        document.getElementById('lucky-boxes').style.display = 'block';
        document.getElementById('lucky-btn').style.display = 'none';
        luckyOpen = true;
        showNotify('3 ta qutidan birini tanlang! üéÅ', "green");
    }, 'quti ochish');
}
function chooseBox(num) {
    if (!luckyOpen) return;
    let winAmount = Math.floor(Math.random() * 10000) + 1000;
    let winType = Math.random() > 0.5 ? 'tanga' : 'olmos';
    if (winType === 'tanga') s.coins += winAmount;
    else s.diamonds += Math.floor(winAmount / 10);
    s.luckyTime = Date.now();
    document.getElementById('lucky-boxes').style.display = 'none';
    document.getElementById('lucky-btn').style.display = 'block';
    luckyOpen = false;
    loadLucky();
    updateUI();
    save();
    showNotify(`\( {num}-quti: + \){winAmount} ${winType === 'tanga' ? 'tanga' : 'olmos'}! üèÜ`, "green");
}
function loadLucky() {
    let now = Date.now();
    let remaining = Math.max(0, (s.luckyTime + 86400000 - now) / 1000);
    document.getElementById('lucky-timer').innerText = remaining > 0 ? `Qolgan: ${Math.floor(remaining / 3600)}soat` : 'O\'ynash mumkin!';
    document.getElementById('lucky-btn').disabled = remaining > 0;
}

// Sahifalar (reklama bilan, professional)
function openPage(id) { 
    runAd(undefined, `${id} sahifasi`); // Reklama chiqishi (bozor, booster, reyting)
    document.querySelectorAll('.page').forEach(p => p.style.display = 'none');
    document.getElementById(id).style.display = 'block';
    if (id === 'p-rank') loadRank();
    if (id === 'p-market') { loadCards(); loadMiners(); }
    if (id === 'p-boost') updateSuperCount(); // Super tap count yangilash
}
function closePage(id) { document.getElementById(id).style.display = 'none'; }

// Super tap count yangilash
function updateSuperCount() {
    document.getElementById('super-count').innerText = s.superTapCount;
}

// Bildirishnomalar (professional, rangli)
function showNotify(m, type = 'green') {
    let el = type === 'green' ? document.getElementById('notify-green') : document.getElementById('notify-red');
    el.innerText = m;
    el.style.display = 'block';
    setTimeout(() => el.style.display = 'none', 3000);
}

// Save (professional, error handling)
function save() { 
    try {
        s.lastTime = Date.now();
        db.ref('users/' + user.id).update(s);
    } catch (error) {
        console.error('Saqlash xatosi:', error);
    }
}

// Interval'lar (mining, super tap, etc.)
setInterval(() => {
    if(s.energy < s.maxE) s.energy = Math.min(s.maxE, s.energy + 1);
    if(s.pphCoin > 0) s.coins += (s.pphCoin / 3600);
    if(s.pphDiam > 0) s.diamonds += (s.pphDiam / 3600);
    if (s.superTapActive && Date.now() > s.superTapEnd) {
        s.superTapActive = false;
        updateUI();
        showNotify('Super Tap vaqti tugadi. Keyingi reklama bilan qayta!', 'orange');
    }
    updateUI();
}, 1000);

setInterval(save, 30000);

// Loading tugatish (5s, xato bilan)
setTimeout(() => {
    let loading = document.getElementById('loading-screen');
    loading.style.opacity = '0';
    setTimeout(() => {
        loading.style.display = 'none';
        tg.expand(); // Telegram UI ni to'liq ochish
    }, 500);
}, 5000);

// Xato handling (global)
window.addEventListener('error', (e) => {
    showNotify('O\'yinda xato: ' + e.message, 'red');
});

tg.expand();
</script>
</body>
</html>
        
    
    
    
        
            
        
                                               
    
            
        
        
    
        
    
    
            
                
            
    
        
        
    
        
                                                       
        
                                    
        
        
    
                                        
                                                                     
        
    
                                                              
            
    
            
            
                                                      
                

